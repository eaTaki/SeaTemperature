---
title: "Laboratory with R"
author: "Enrique Akira Takiguchi and Itziar Salazar"
date: "2025-12-31"
output: pdf_document
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

[**Problem statement:**]{.smallcaps} Europe is affected by climate change and its effects are not only perceived on earth. European water bodies (lakes, rivers and oceans and seas of the continent) are also affected. Given that there is more water than land on the planet’s surface, it is not surprising that the warming of the oceans has accounted for about 93 % of the global warming since the 1950s. This warming occurs as a result of the increase in greenhouse gas emissions, especially carbon dioxide, which in turn trap more and more solar energy within the atmosphere. Most of this trapped heat is eventually stored in the oceans, which affects the temperature and the circulation of water. Sea surface temperatures on European coasts are rising more rapidly than those in the world oceans. Water temperature represents one of the most important regulatory elements of marine life. Temperature increases are already causing major changes under the surface of the water

------------------------------------------------------------------------

# Exercise 1

## 1.a,b) Data importation, variable specification, and metadata definition

The data set `sea_data` is **directly sourced** from [IDESCAT](https://www.idescat.cat/indicadors/?id=aec&n=15196), with the variable names set as per the original dataset. Technical **metadata**, including measurement units and descriptions of variables such as years, months, and depth, has been **added** using the [`label`]{.smallcaps} function of the [`hmisc`]{.smallcaps} package to tag variables.

The data set shows the temperature of the sea in degrees Celsius at depths of 0, -20, -50, and -80 meters between 2000 and 2017. These measurements were taken at L'Estartit observation point on the Costa Brava, which is one mile east of the Medes Islands (Girona). The coordinates of this location are $42^{\circ} 03'$ N and $3^{\circ} 15'$ E.

```{r Download, echo=FALSE, warning=FALSE, message=FALSE}
source('code/CreateDF.R')
if (!file.exists('data/sea_data.RData')){
  download_data('data/sea_data.RData')
}
load('data/sea_data.RData')

library(gplots)
library(ggplot2)
library(dplyr)
library(tidyr)
library(gplots)
library(RColorBrewer)
library(plotrix)
library(stringr)
library(ncdf4)

mes_cat <- c("Gener", "Febrer", "Mar\u00e7", "Abril", "Maig", "Juny", 
           "Juliol", "Agost", "Setembre", "Octubre", "Novembre", "Desembre", "Mitjana anual")

mes_l = c("January", "February", "March", "April", "May", "June", 
           "July", "August", "September", "October", "November", "December", "Annual Average")

sea.deep$mes = mes_l[match(sea.deep$mes, mes_cat)]
sea.pred$mes = mes_l[match(sea.pred$mes, mes_cat)]

```

## 1.c) Data structure

The data frame `sea.deep` is checked to make sure it is complete and correct. The internal organization of the data is inspected to **verify** that **data types** and the previously assigned **attributes** in *1.a,b* are correctly integrated. We make a **summary** of the data so we can see at a glance what the main values are, and how far they range. We also check that there are no **NAs** in the dataset.

```{r, Dimensionality, echo=FALSE, warning=FALSE}
cat("Dimension df_yearly\n")
dim_sea.deep <- dim(sea.deep)
cat("Rows (obs.):", dim_sea.deep[1], "\n")
cat("Columns (var.):", dim_sea.deep[2], "\n")
print(str(sea.deep)) #Structure of the df, dimensions, variables and data types
print(summary(sea.deep)) #Descriptive statistical summary: mean, quantiles, min, max, NAs...
print(sum(is.na(sea.deep))) #Just to make sure there are no NAs
```

## 1.d) Visual distribution

The way the **seawater temperature changes over time** can be seen in the box-plots, which are divided into categories based on depth and year. This picture helps us to spot changes in temperature, patterns over time, and anything unusual across depths from 2000 to 2017.

```{r Boxplots, echo=FALSE, warning=FALSE}
ggplot(sea.deep, aes(x = factor(fondaria), y = temperatura)) + #Treated as a factor to represent depth levels on the x-axis
  geom_boxplot() +
  facet_wrap(~any) + #Multi-panel layout categorised by year 
  labs( #Definition of labels and titles 
    title = "Boxplot of temperature by depth (2000-2017)",
    x = "Depth (m)", 
    y = "Temperature (Celsius)"
  )
```

## 1.e) Quantitative summary

A **quantitative characterization** is done by calculating the mean, median, standard deviation, and interquartile range for each group. This analysis is **supported by other indicators**, such as the **absolute range** and the **coefficient of variation**, which provide a strong assessment of both dispersion and relative variability.

The statistical summary is done in two stages. First, it looks at how the temperature changes with depth and year. Then, it puts these average temperatures together across the whole period (2000–2017). These estimators help us to compare the **central tendency** and the **stability of the vertical temperature distributions** at the specific depths recorded.

```{r, StatisticalAnalysis, echo=FALSE, warning=FALSE}

stats1 <- sea.deep %>% #Detailed statistical summary by depth and year
  group_by(fondaria, any) %>%
  summarise(
    Mitjana = mean(temperatura),
    Mediana = median(temperatura),
    SD = sd(temperatura),
    IQR = IQR(temperatura),
    Min = min(temperatura), #Other statistics of interest
    Max = max(temperatura),
    Range = Max - Min, #Difference between max and min values
    CV = SD / Mitjana, #Coefficient of Variation (CV)
    .groups = 'drop'
   ) 

print(stats1) 
View(stats1) #Average temperature per depth per year

temp_dy <- sea.deep %>% #Isolating the average temperature per depth and year
  group_by(fondaria, any) %>% #Variables of interest
  summarise(
    temp_mitja = mean(temperatura),
    .groups = 'drop'
  ) #New variable average temperature per depth per year
print(temp_dy)

stats2 <- temp_dy %>% #Aggregate statistics by depth 
  group_by(fondaria) %>%
  summarise(
    Mitjana = mean(temp_mitja),
    Mediana = median(temp_mitja),
    SD = sd(temp_mitja),
    IQR = IQR(temp_mitja),
    Min = min(temp_mitja), #Other statistics of interest
    Max = max(temp_mitja),
    Range = Max - Min, #Difference between max and min values
    CV = SD / Mitjana, #Coefficient of Variation (CV)
    .groups = 'drop'
  )

print(stats2) 
View(stats2) #Average temperature by depth across 2000-2017   

```

## 1.f) Annual thermal trends

To represent the data to be able to see the annual variations of the average temperature in the total depths and years studied, a **multi-line plot** was generated using [`ggplot2`]{.smallcaps} . By mapping years on the x-axis and average temperatures on the y-axis, and using different colors representing different depths, the graph shows how temperatures have changed over time and how stable the temperature distributions are. It effectively shows **synchronized inter-annual fluctuations across depths**, as well as a **general warming trend** observed during 2000-2017 time period.

```{r AnnnualVariations, echo=FALSE, warning=FALSE}
stats1 <- stats1 %>%
  mutate(fondaria = factor(fondaria, levels = c(0, -20, -50, -80))) #Ensure depth levels are trated as categorical factors

ggplot(stats1, aes( #Create the time-series plot
  x = any, 
  y = Mitjana, 
  color = fondaria)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Annual average temperature variation by depth",
    subtitle = " (2000-2017) Mediterranean sea, at: 42 03' N, 3 15' E", #####Acabar de decidir títols i subtítols
    x = "Year",
    y = "Average temperature (Celsius)",
    color = "Depth (m)"
  ) +
  theme_minimal()
  theme(legend.position = "bottom") # Optional: Move legend to bottom for better horizontal space

```

## 1.g) Data export to Excel

The **information** that has been processed is **sent to an outside .xlsx file** using the [`openxlsx`]{.smallcaps} package. This process makes sure that the data is stored and can be used for external reporting or further analysis. The Excel file has two sheets, including `stats_per_any` and `stats_global` .

```{r, Excel, echo=FALSE, warning=FALSE, include=FALSE}
library(openxlsx)

new_var <- createWorkbook()
#Average temperature per depth per year
addWorksheet(new_var, "Stats_per_any")
writeData(new_var, "Stats_per_any", stats1)
#Average temperature per depth across 2000-2017   
addWorksheet(new_var, "Stats_globals")
writeData(new_var, "Stats_globals", stats2)
#Save on a new excel file
saveWorkbook(new_var, "data/NUEVO.xlsx", overwrite = TRUE)
```

# Exercise 2

## 2.a) Heat map with "Gplots"

Following the instructions we generate a heat map using [`gplots`]{.smallcaps} package, showing annual mean water temperature changes across time and depths.

```{r Heatmap, echo=FALSE, warning=FALSE}
#Run libraries 


#Remove annual average temperature observations, keep only the months from January to December
if ("mes" %in% names(sea.deep)) {
  obs <- sea.deep[sea.deep$mes != "Annual Average", ]
} else {
  obs <- sea.deep
}

temp_dy <- obs %>% #Calculate the average temperature per year by depth
  group_by(any, fondaria) %>%
  summarise(
    mean = mean(temperatura),
    sd   = sd(temperatura),
    n    = n(),
    .groups = "keep"
  ) %>%
  ungroup() %>%
  arrange(any, fondaria)

#Prepare the data for heatmap.2 representation by creating two matrices 
fondaria <- c(-80, -50, -20, 0)

matriu_1 <- temp_dy %>%
  select(any, fondaria, mean) %>%
  pivot_wider(names_from = fondaria, values_from = mean) %>%
  arrange(any)
anys <- matriu_1$any
columnes <- intersect(as.character(fondaria), colnames(matriu_1))
rownames(matriu_1) <- anys
mitjana_temp_mat <- as.matrix(matriu_1[, columnes])

matriu_2 <- temp_dy %>%
  select(any, fondaria, sd) %>%
  pivot_wider(names_from = fondaria, values_from = sd) %>%
  arrange(any)
rownames(matriu_2) <- matriu_2$any
sd_temp_mat <- as.matrix(matriu_2[, columnes])

tons_heatmap <- colorRampPalette(brewer.pal(9, "YlOrRd"))(100) #Select map color palette

heatmap.2( #Map design and specifications
  mitjana_temp_mat,
  Rowv = FALSE, Colv = FALSE, dendrogram = "none",
  trace = "none", key = TRUE, density.info = "none",
  col = tons_heatmap, na.color = "grey90",
  margins = c(7, 9),
  main = "",
  xlab = "depth (m)", ylab = "Year",
  labCol = columnes,
  labRow = as.character(anys),
  cexRow = 0.9, cexCol = 1.0,
  add.expr = {
    nr <- nrow(sd_temp_mat); nc <- ncol(sd_temp_mat)
    for (j in seq_len(nc)) {
      s <- sd_temp_mat[, j]
      if (all(is.na(s))) next
      rng <- range(s)
      y <- sapply(seq_len(nr), function(i) nr - i + 1)
      if (!is.finite(diff(rng)) || diff(rng) == 0) {
        x <- rep(j, nr)
      } else {
        x_scaled <- (s - rng[1]) / diff(rng)
        x <- (j - 0.5) + x_scaled
      }
      lines(x, y, col = "cyan3", lwd = 2)
      points(x, y, col = "cyan3", pch = 20, cex = 0.75)
    }
  }
)
#Late addition of the title and adjustments to avoid overlap
par(font.main = 1)
title("Average temperature by year and depth",
      adj = 1,           
      line = 1.2,        
      cex.main = 1.1)   
```

The heat map shows how the annual mean water temperature has changed at different depths (-80, -50, -20 and 0 meters) between 2000 and 2017. The color distribution shows that **surface waters** (0 and -20 meters) are consistently **the warmest** and show the **greatest inter-annual variability**. This variability is evident in the blue lines representing the standard deviation, which are imposed on the heat map. The **deeper layers** (-50 and -80 meters) display a **colder and more stable thermal profile**, much less variation, suggesting less impact from seasonal cycles.

The **years between 2014 and 2016** were a time of particularly **intense warming**. This was seen at the surface, and it is thought that it may have been caused by changes in the ocean or the climate.

## 2.b) Radial plot with "plotrix"

We used the [`plotrix`]{.smallcaps} package to make a radial plot. This shows the average monthly temperature changes across time and depths.

```{r Radial, echo=FALSE, warning=FALSE}
#Run libraries

par(font.main = 1) #Set the title font to plain text

radial_data <- sea.deep %>% #Filter out annual averages and calculate mean temperature per month and depth
  filter(mes != 'Annual Average') %>%
  mutate(mes = factor(mes, levels = mes_l)) %>%
  group_by(mes, fondaria) %>%
  summarise(avg_temp = mean(temperatura, na.rm = TRUE), .groups = 'drop')

plot_matrix <- radial_data %>% #Data as matrix for the radial plot
  pivot_wider(names_from = fondaria, values_from = avg_temp) %>%
  arrange(mes) %>%
  select(-mes) %>%
  as.matrix()

plot_matrix = rbind(plot_matrix, plot_matrix[1, 1:4]) #Append the first row to the end so the lines connect back to January

depth_levels <- colnames(plot_matrix) #Setup parameters
num_depths <- length(depth_levels)

col_set = c("#F8766D","#7CAE00", "#00BFC4", "#C77CFF")

angles <- c((0:(length(mes_l) - 1)) * (2 * pi / length(mes_l)),0) #Calculate angles in radians for each month

radial.plot( #Plot design and specifications
  t(plot_matrix), radial.pos = t(replicate(4, angles)), rp.type = "l",
  lty = 4, lwd = 2,
  labels = mes_l, label.pos = angles, line.col = col_set,
  radial.lim = c(0, 30),
  main = "Average Monthly Temperature by Depth (All Years)",
  clockwise = TRUE, start = pi/2
)


legend(
  "bottomright", legend = paste(depth_levels, "m"),
   col=col_set, lty = 4, lwd = 2, bty = "n"
)
```

The radial plot shows how average temperatures recorded at different depths (-80, -50, -20 and 0 meters) changed across each month of the year from 2000 to 2017. The lines are almost perfectly overlapped **between December and March**, showing that **temperature values remain almost identical regardless of depth**. However, there is a **change** that starts **in April**, and becomes more obvious during the summer months. While surface temperatures at 0 and -20 meters show a sharp increase towards higher values, the deeper measurements at -50 and -80 meters remain closer to the center of the graph. As the year progresses into **November and December**, these **temperature values contract and converge again.**

Furthermore, the plot shows that the **surface** has a **lot of** monthly temperature **variations**, while the **deeper layers** have a much **more consistent** and narrow temperature range throughout the year.

# Exercise 3

A function is scheduled to do the following:

-   a\. Calculate the temperature **difference between one month and the following month** for each year and depth, offering a graph for each specified year and the average of all years studied.

-   b\. Calculate the **difference in temperature between each month and the same month of the previous 30 years**, offering a graph for each year and the average for all years studied.

## 3.a) Monthly rate of temperature change

This analysis represents **inter-monthly temperature variation**. This is very useful to observe seasonal warming and cooling rates at different depths.

```{r MontlyChange, echo=FALSE, warning=FALSE}

source('code/Ex3.R')
plots = ex3(sea.deep, sea.pred)
print(plots$a)

```

## 3.b) Historical comparison

This analysis looks at **decade temperature anomalies**. The resulting graphs show if a specific month was warmer or cooler than usual, providing insight into ongoing warming trends or unusual years.

```{r Historical, echo=FALSE, warning=FALSE}
print(plots$b1)
```

```{r YearlyHistorical, echo=FALSE, warning=FALSE}
print(plots$b2)
```

## 3.c) Function validation and testing

To make sure the function works properly and everything runs smoothly, we generate some simulated temperatures. For this, we use a noisy sine function with a period of 12 months.

```{r, echo=FALSE, warning=FALSE}
#Define simulation parameters
anys = 18 
min_sim = 13
ampl_sim = c(1,2,3,4)
#Structure of simulated df 
sim.deep = data.frame(
  mes = rep(mes_l[1:12], anys, each=4),
  fondaria = rep(fondaria, anys*12),
  any = rep(seq(2000, 2000+anys-1), each=4*12),
  temperatura = rep(0, 4*12*anys)
)
for (i in 1:4){ #Loop
  sim_t = sin(2*pi*(seq(0, anys, 1/12)-5/12))*ampl_sim[i]
  sim_t = sim_t + rnorm(length(sim_t), min_sim+ampl_sim[i], 1)
  sim.deep$temperatura[sim.deep$fondaria==fondaria[i]] = sim_t[1:length(sim_t)-1]
}
#Process the data to create long-term trends
sim.pred <- sim.deep %>%
  group_by(mes, fondaria) %>%
  arrange(any, .by_group = TRUE) %>%
  mutate(temperatura_accum = cummean(temperatura)) %>% #To smooth out year-to-year noise
  ungroup()
```

```{r, warning=FALSE}
plots = ex3(sim.deep, sim.pred)
print(plots$b2)
```

## 3.d) Discussion of results

When we look at how **temperatures change from month to month**, we can see a **clear difference between the surface and deeper waters during summer periods**. For instance in August, the surface is about 23°C, but the water at -80 meters is much cooler and more stable. This means there is a risk of different layers of water getting too hot or too cold. This happens because warm water is lighter than cold water creating a "cap" on the surface that acts like a barrier that stops oxygen from moving down and nutrients from moving up.

This process is called **stratification** and can eventually lead to a **collapse of the food chain** and create **dead zones** where there is too little oxygen for animals and plants to survive. Furthermore, if we compare the temperatures of the last few years to the average temperature between 1974 and 1999, we can see that the **temperature has been getting steadily higher**. The **water** was **much warmer than usual in 2003, 2011, and 2017.**

We used pretend data to show that our function and our calculations are correct. We created a mathematical "sine wave" to copy the natural 12-month cycle of the seasons. This showed that we can spot regular patterns even when there is random "noise" in the data. If we calculate the average of the total, we can make the results more stable and reliable. This helps us to see the bigger picture without getting distracted by small changes that happen every year.

In summary, the results show that **the sea is getting warmer**, which is a big threat to marine biodiversity. The difference between the temperatures at the surface of the ocean and at depth is getting bigger, and we are seeing more heat spikes than before. These changes are not just part of a natural cycle but they are clear signs of climate change.

## 3.e) Additional data crossing and correlation analysis

We look for other data to better explain the climate change that is taking place. To be more specific, we are looking for information about the salt content of the water at a close location to $42^{\circ} 03'$ N and $3^{\circ} 15'$ E and at depths 0, -20, -50 and -80 meters. We get our information from the [Copernicus Marine Service](https://data.marine.copernicus.eu/product/MEDSEA_ANALYSISFORECAST_BGC_006_014/description).

The **saltiness of water** is as important as temperature when diagnosing climate change, but it tells us different things than temperature alone. **Salinity** is a **key indicator** of **changes in the water cycle**, which is important for understanding how water moves around the world. When it gets warmer, more water evaporates and the water becomes saltier. If the salt levels in the ocean suddenly dropped a lot, it could be a sign of extreme weather or melting ice on other parts of the planet.

**Changes in the amount of salt in the water change how thick or thin the water is**, and can make the layers of the water more stable. Alongside temperature, salinity drives the thermohaline circulation of ocean currents, so disruptions in these levels can increase stratification.

```{r, echo=FALSE, warning=FALSE}


# Loading the file
nc_file = nc_open("data/cmems_mod_med_phy-sal_my_4.2km_P1M-m_1766852522604.nc")

# Extracting the data and transforming to a dataframe
salinity_mat = ncvar_get(nc_file, nc_file$var[[1]])
salinity = data.frame(
  Time = rep(nc_file$dim$time$vals, times = nrow(salinity_mat)),
  fondaria = rep(round(nc_file$dim$depth$vals), times = ncol(salinity_mat)),
  salinitat = as.vector(salinity_mat)
)

# Changing dates to year/month
date_objs = as.POSIXct(salinity$Time, origin = "1970-01-01", tz = "UTC")
salinity$any = as.numeric(format(date_objs, "%Y"))
month_index = as.numeric(format(date_objs, "%m"))
salinity$mes = mes_l[month_index]
salinity$Time = NULL

# Adjusting depths to fit existing data
salinity <- salinity[salinity$fondaria %in% c(1, 19, 51, 79), ]
salinity$fondaria[salinity$fondaria == 1] = 0
salinity$fondaria[salinity$fondaria == 19] = -20
salinity$fondaria[salinity$fondaria == 51] = -50
salinity$fondaria[salinity$fondaria == 79] = -80

# Creating combined dataframe to estimate linear relation
df_combined <- sea.deep %>%
  inner_join(salinity, by = c("any", "mes", "fondaria"), suffix = c("_df1", "_df2"))


correlation_value <- cor(df_combined$temperatura, 
                         df_combined$salinitat, 
                         use = "complete.obs")

print(correlation_value)

aa = lm(temperatura ~ salinitat, df_combined)
summary(aa)
```

By combining these sets of data, we can **better tell the difference between the usual seasonal changes and long-term shifts caused by climate change**, which changes how water moves through the environment. The data shows that temperature and salinity usually go in opposite directions. Although the connection is only weak with a **correlation** of **-0.12**, the very low **p-value** of **0.00032** shows that this link is not just a coincidence.

The **multiple R-squared** of **0.0149** shows that salinity explains only about 1.5% of the variation in temperature. This **result** is **expected as the temperature of seawater is primarily driven by the sun** and changes with the seasons, rather than the salt content alone. But the data also shows that **when the sea is very salty, it is often very hot**.

In conclusion, while salinity is not the main cause of temperature changes, it is an important tool for understanding the biochemical changes triggered by global warming. Our model clearly shows a connection between these two variables. When we look at how climate change is affecting the sea, measuring salt levels and temperature helps us to see **how the layers of the sea are becoming more separated**. This can help us to see more accurately, the increasing stratification of the water column, **predicting the emergence of hypoxic zones** that threaten marine biodiversity.

## 3.f) Project reproductibility and additional documentation

To make sure the analysis is transparent and can be recreated by anyone, a **public repository** named [**"SeaTemperature"**](https://github.com/eaTaki/SeaTemperature) has been set up on **GitHub** \<[https://github.com/eaTaki/SeaTemperature](http://127.0.0.1:24511/#0 "https://github.com/eaTaki/SeaTemperature")\>. This repository is a central open-source storage space for the following components:

-   The assignment instructions.

-   The presented Rmarkdown document.

-   The data used to complete the assignment under`sea_data.RData` . As well as salinity data used to complete exercise *3.e*.

-   An R library that stores the functions used for the completion of this project, thus being: `CreateDF.R` and `Ex3.R`.
