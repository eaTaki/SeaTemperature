---
title: "Laboratory with R"
author: "Enrique Akira Takiguchi and Itziar Salazar"
date: "2025-12-31"
output: pdf_document
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Exercise 1

### Download data (1a, 1b)

```{r Download}
source('CreateDF.R')
if (!file.exists('sea_data.RData')){
  download_data('sea_data.RData')
}
load('sea_data.RData')

```

### Check dimensionality (1c)

```{r, Dimensionality}
cat("Dimension df_yearly\n")
dim_sea.deep <- dim(sea.deep)
cat("Rows (obs.):", dim_sea.deep[1], "\n")
cat("Columns (var.):", dim_sea.deep[2], "\n")
print(str(sea.deep)) #Structure of the df, dimensions, variables and data types
print(summary(sea.deep)) #Descriptive statistical summary: mean, quantiles, min, max, NAs...
print(sum(is.na(sea.deep))) #Just to make sure there are no NAs
```

### Boxplot representation (1d)

```{r Boxplots, echo=FALSE}
library(ggplot2)
ggplot(sea.deep, aes(x = factor(fondària), y = temperatura)) +
  geom_boxplot() +
  facet_wrap(~any) +
  labs(
    title = "Boxplot de la temperatura per fondària (2000-2017)",
    x = "Fondària (m)", 
    y = "Temperatura (°C)"
  )
```

### Statistical analysis (1e)

```{r, StatisticalAnalysis}
library(dplyr)

stats1 <- sea.deep %>%
  group_by(fondària, any) %>%
  summarise(
    Mitjana = mean(temperatura),
    Mediana = median(temperatura),
    SD = sd(temperatura),
    IQR = IQR(temperatura),
    Min = min(temperatura), #Other statistics of interest
    Max = max(temperatura),
    Range = Max - Min, #Difference between max and min values
    CV = SD / Mitjana, #Coefficient of Variation (CV)
    .groups = 'drop'
   ) 

print(stats1) 
View(stats1) #Average temperature per depth per year

temp_dy <- sea.deep %>% 
  group_by(fondària, any) %>% #Variables of interest
  summarise(
    temp_mitja = mean(temperatura),
    .groups = 'drop'
  ) #New variable average temperature per depth per year
print(temp_dy)

stats2 <- temp_dy %>%
  group_by(fondària) %>%
  summarise(
    Mitjana = mean(temp_mitja),
    Mediana = median(temp_mitja),
    SD = sd(temp_mitja),
    IQR = IQR(temp_mitja),
    Min = min(temp_mitja), #Other statistics of interest
    Max = max(temp_mitja),
    Range = Max - Min, #Difference between max and min values
    CV = SD / Mitjana, #Coefficient of Variation (CV)
    .groups = 'drop'
  )

print(stats2) 
View(stats2) #Average temperature per depth across 2000-2017   

```

### Annual variations (1f)

```{r AnnnualVariations, echo=FALSE}
stats1 <- stats1 %>%
  mutate(fondària = factor(fondària, levels = c(0, -20, -50, -80))) #Ensure depth levels are trated as categorical factors

ggplot(stats1, aes( #Create the time-series plot
  x = any, 
  y = Mitjana, 
  color = fondària)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Variació anual de la temperatura mitjana per fondària",
    subtitle = " (2000-2017) Mar Mediterrani, punt d'observació: 42º 03' N, 3º 15' E", #####Acabar de decidir títols i subtítols
    x = "Any",
    y = "Temperatura mitjana (°C)",
    color = "Fondària (m)"
  ) +
  theme_minimal()
  theme(legend.position = "bottom") # Optional: Move legend to bottom for better horizontal space

```

### Save to Excel (1g)

```{r, Excel}
library(openxlsx)

new_var <- createWorkbook()
#Average temperature per depth per year
addWorksheet(new_var, "Stats_per_any")
writeData(new_var, "Stats_per_any", stats1)
#Average temperature per depth across 2000-2017   
addWorksheet(new_var, "Stats_globals")
writeData(new_var, "Stats_globals", stats2)
#Save on a new excel file
saveWorkbook(new_var, "NUEVO.xlsx", overwrite = TRUE)
```

## Exercise 2

### Plot1 - Heatmap

```{r Heatmap, echo=FALSE}
#Run libraries 
library(tidyr)
library(gplots)
library(RColorBrewer)

#Remove annual average temperature observations, keep only the months from January to December
if ("mes" %in% names(sea.deep)) {
  obs <- sea.deep[sea.deep$mes != "Mitjana anual", ]
} else {
  obs <- sea.deep
}

temp_dy <- obs %>% #Calculate the average temperature per year by depth
  group_by(any, fondària) %>%
  summarise(
    mean = mean(temperatura),
    sd   = sd(temperatura),
    n    = n()
  ) %>%
  ungroup() %>%
  arrange(any, fondària)

#Prepare the data for heatmap.2 representation by creating two matrices 
fondària <- c(-80, -50, -20, 0)

matriu_1 <- temp_dy %>%
  select(any, fondària, mean) %>%
  pivot_wider(names_from = fondària, values_from = mean) %>%
  arrange(any)
anys <- matriu_1$any
columnes <- intersect(as.character(fondària), colnames(matriu_1))
rownames(matriu_1) <- anys
mitjana_temp_mat <- as.matrix(matriu_1[, columnes])

matriu_2 <- temp_dy %>%
  select(any, fondària, sd) %>%
  pivot_wider(names_from = fondària, values_from = sd) %>%
  arrange(any)
rownames(matriu_2) <- matriu_2$any
sd_temp_mat <- as.matrix(matriu_2[, columnes])

tons_heatmap <- colorRampPalette(brewer.pal(9, "YlOrRd"))(100) #Select map color palette

heatmap.2( #Map design and specifications
  mitjana_temp_mat,
  Rowv = FALSE, Colv = FALSE, dendrogram = "none",
  trace = "none", key = TRUE, density.info = "none",
  col = tons_heatmap, na.color = "grey90",
  margins = c(7, 9),
  main = "",
  xlab = "Fondària (m)", ylab = "Any",
  labCol = columnes,
  labRow = as.character(anys),
  cexRow = 0.9, cexCol = 1.0,
  add.expr = {
    nr <- nrow(sd_temp_mat); nc <- ncol(sd_temp_mat)
    for (j in seq_len(nc)) {
      s <- sd_temp_mat[, j]
      if (all(is.na(s))) next
      rng <- range(s)
      y <- sapply(seq_len(nr), function(i) nr - i + 1)
      if (!is.finite(diff(rng)) || diff(rng) == 0) {
        x <- rep(j, nr)
      } else {
        x_scaled <- (s - rng[1]) / diff(rng)
        x <- (j - 0.5) + x_scaled
      }
      lines(x, y, col = "cyan3", lwd = 2)
      points(x, y, col = "cyan3", pch = 20, cex = 0.75)
    }
  }
)
#Late addition of the title and adjustments to avoid overlap
title("Temperatura mitjana per any i fondària",
      adj = 1,           
      line = 1.2,        
      cex.main = 1.1)   
```

The heatmap shows how the annual mean water temperature changes at different depths (-80, -50, -20 and 0 meters) between 2000 and 2017. The colour distribution shows that surface waters (0 and -20 meters) are consistently the warmest and exhibit the greatest interannual variability. This variability is evident in the blue lines representing the standard deviation (SD), which are imposed on the heatmap. The deeper layers (-50 and -80 meters) display a colder and more stable thermal profile, with significantly reduced standard deviation, indicating lower influence from seasonal cycles. The period between 2014 and 2016 stands out as particularly intense warming conditions are observed at the surface, potentially driven by large-scale oceanographic or climatic dynamics.

### Plot2 -

```{r Radial}
#Run library 
library(plotrix) 

mes_l <- c("Gener", "Febrer", "Març", "Abril", "Maig", "Juny", 
           "Juliol", "Agost", "Setembre", "Octubre", "Novembre", "Desembre")

radial_data <- sea.deep %>% #Filter out annual averages and calculate mean temperature per month and depth
  filter(mes != 'Mitjana anual') %>%
  mutate(mes = factor(mes, levels = mes_l)) %>%
  group_by(mes, fondària) %>%
  summarise(avg_temp = mean(temperatura, na.rm = TRUE), .groups = 'drop')

plot_matrix <- radial_data %>% #Data as matrix for the radial plot
  pivot_wider(names_from = fondària, values_from = avg_temp) %>%
  arrange(mes) %>%
  select(-mes) %>%
  as.matrix()

plot_matrix = rbind(plot_matrix, plot_matrix[1, 1:4]) #Append the first row to the end so the lines connect back to January

depth_levels <- colnames(plot_matrix) #Setup parameters
num_depths <- length(depth_levels)

col_set = c("blue","cyan", "green", "coral")

angles <- c((0:(length(mes_l) - 1)) * (2 * pi / length(mes_l)),0) #Calculate angles in radians for each month

radial.plot( #Plot design and specifications
  t(plot_matrix), radial.pos = t(replicate(4, angles)), rp.type = "l",
  lty = 4, lwd = 2,
  labels = mes_l, label.pos = angles, line.col = col_set,
  radial.lim = c(0, 30),
  main = "Average Monthly Temperature by Depth (All Years)",
  clockwise = TRUE, start = pi/2
)


legend(
  "bottomright", legend = paste(depth_levels, "m"),
   col=col_set, lty = 4, lwd = 2, bty = "n"
)
```

The radial plot shows how average temperatures recorded at different depths (-80, -50, -20 and 0 metres) changed across each month of the year from 2000 to 2017. The near-perfect overlap of the lines between December and March stands out, showing that temperature values remain almost identical regardless of depth. In contrast, a shift begins in April, becoming most pronounced during the summer months. While surface temperatures at 0 m and -20 m show a sharp expansion towards higher values, deeper measurements at -50 m and -80 m remain closer to the center of the plot. As the year progresses into November and December, these temperature values contract and converge again. Furthermore, the plot shows that the surface is subject to significant monthly temperature fluctuations, whereas the deeper layers have a much more consistent and narrow temperature range throughout the year.

## Exercise 3

### a) Temperature differences between months

```{r MontlyChange}
library(stringr )
source('Ex3.R')
plots = ex3(sea.deep, sea.pred)
print(plots$a)

```

### b) Temperature differences between years

```{r Historical}
print(plots$b1)
```

```{r YearlyHistorical}
print(plots$b2)
```

### c) Simulated dataframe

We now generate some simulated temperatures. We are going to use a noisy sine function with a period of 12 months

```{r}
anys = 18
min_sim = 13
ampl_sim = c(1,2,3,4)
sim.deep = data.frame(
  mes = rep(mes_l, anys, each=4),
  fondària = rep(fondària, anys*12),
  any = rep(seq(2000, 2000+anys-1), each=4*12),
  temperatura = rep(0, 4*12*anys)
)
for (i in 1:4){
  sim_t = sin(2*pi*seq(0, anys, 1/12))*ampl_sim[i]
  sim_t = sim_t + rnorm(length(sim_t), min_sim+ampl_sim[i], 1)
  sim.deep$temperatura[sim.deep$fondària==fondària[i]] = sim_t[1:length(sim_t)-1]
}

sim.pred <- sim.deep %>%
  group_by(mes, fondària) %>%
  arrange(any, .by_group = TRUE) %>%
  mutate(temperatura_accum = cummean(temperatura)) %>%
  ungroup()
```

Checking it

```{r}
plots = ex3(sim.deep, sim.pred)
print(plots$b2)
```

### e) Additional data (salinity) crossing

```{r}
library(ncdf4)

# Loading the file
nc_file = nc_open("cmems_mod_med_phy-sal_my_4.2km_P1M-m_1766852522604.nc")

# Extracting the data and transforming to a dataframe
salinity_mat = ncvar_get(nc_file, nc_file$var[[1]])
salinity = data.frame(
  Time = rep(nc_file$dim$time$vals, times = nrow(salinity_mat)),
  fondària = rep(round(nc_file$dim$depth$vals), times = ncol(salinity_mat)),
  salinitat = as.vector(salinity_mat)
)

# Changing dates to year/month
date_objs = as.POSIXct(salinity$Time, origin = "1970-01-01", tz = "UTC")
salinity$any = as.numeric(format(date_objs, "%Y"))
month_index = as.numeric(format(date_objs, "%m"))
salinity$mes = mes_l[month_index]
salinity$Time = NULL

# Adjusting depths to fit existing data
salinity <- salinity[salinity$fondària %in% c(1, 19, 51, 79), ]
salinity$fondària[salinity$fondària == 1] = 0
salinity$fondària[salinity$fondària == 19] = -20
salinity$fondària[salinity$fondària == 51] = -50
salinity$fondària[salinity$fondària == 79] = -80

# Creating combinet dataframe to estimate linear relation
df_combined <- sea.deep %>%
  inner_join(salinity, by = c("any", "mes", "fondària"), suffix = c("_df1", "_df2"))

correlation_value <- cor(df_combined$temperatura, 
                         df_combined$salinitat, 
                         use = "complete.obs")

print(correlation_value)

aa = lm(temperatura ~ salinitat, df_combined)
summary(aa)
```
