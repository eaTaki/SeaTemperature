---
title: "Laboratory with R"
author: "Enrique Akira Takiguchi and Itziar Salazar"
date: "2025-12-31"
output: pdf_document
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

[Problem statement:]{.smallcaps} Europe is affected by climate change and its effects are not only perceived on earth. European water bodies (lakes, rivers and oceans and seas of the continent) are also affected. Given that there is more water than land on the planet’s surface, it is not surprising that the warming of the oceans has accounted for about 93 % of the global warming since the 1950s. This warming occurs as a result of the increase in greenhouse gas emissions, especially carbon dioxide, which in turn trap more and more solar energy within the atmosphere. Most of this trapped heat is eventually stored in the oceans, which affects the temperature and the circulation of water. Sea surface temperatures on European coasts are rising more rapidly than those in the world oceans. Water temperature represents one of the most important regulatory elements of marine life, so that temperature increases are already causing major changes under the surface of the water

## Exercise 1

### 1.a,b) Data ingestion, variable specification, and metadata definition

The dataset sea_data is directly sourced from IDESCAT <https://www.idescat.cat/indicadors/?id=aec&n=15196>, with the variable names set as per the original dataset. Technical metadata, including measurement units and descriptions of variables such as years, months, and depth, has been added using the [label]{.smallcaps} function of the [Hmisc]{.smallcaps} package to tag variables. The data set shows the temperature of the sea in degrees Celsius at depths of 0, 20, 50, and 80 metres between 2000 and 2017. These measurements were taken at L'Estartit observation point on the Costa Brava, which is one mile east of the Medes Islands (Girona). The coordinates of this location are $42^{\circ} 03'$ N and $3^{\circ} 15'$ E.

```{r Download}
source('CreateDF.R')
if (!file.exists('sea_data.RData')){
  download_data('sea_data.RData')
}
load('sea_data.RData')

```

### 1.c) Data structure

The sea.deep data frame is checked to make sure it is complete and correct. The internal organization of the data is inspected to verify that data types and the previously assigned attributes are correctly integrated. What's more, we make a summary of the data so we can see at a glance what the main values are, and how far they range. We also check that there are no missing values in the dataset.

```{r, Dimensionality}
cat("Dimension df_yearly\n")
dim_sea.deep <- dim(sea.deep)
cat("Rows (obs.):", dim_sea.deep[1], "\n")
cat("Columns (var.):", dim_sea.deep[2], "\n")
print(str(sea.deep)) #Structure of the df, dimensions, variables and data types
print(summary(sea.deep)) #Descriptive statistical summary: mean, quantiles, min, max, NAs...
print(sum(is.na(sea.deep))) #Just to make sure there are no NAs
```

### 1.d) Visual distribution

The way the seawater temperature changes over time can be seen in the boxplots, which are divided into categories based on depth and year. This picture helps us to spot changes in temperature, patterns over time, and anything unusual across different depths from 2000 to 2017.

```{r Boxplots, echo=FALSE}
library(ggplot2)
ggplot(sea.deep, aes(x = factor(fondària), y = temperatura)) + #Treated as a factor to represent depth levels on the x-axis
  geom_boxplot() +
  facet_wrap(~any) + #Multi-panel layout categorised by year 
  labs( #Definition of labels and titles 
    title = "Boxplot de la temperatura per fondària (2000-2017)",
    x = "Fondària (m)", 
    y = "Temperatura (°C)"
  )
```

### 1.e) Quantitative summary

A quantitative characterisation is done by calculating the mean, median, standard deviation, and interquartile range for each group. This analysis is supported by other indicators, such as the absolute range and the Coefficient of Variation (CV), which provide a strong assessment of both dispersion and relative variability. The statistical summary is done in two stages. First, it looks at how the temperature changes with depth and year. Then, it puts these average temperatures together across the whole study period (2000–2017). These estimators help us to compare the central tendency and the stability of the thermal profiles at the specific depths recorded.

```{r, StatisticalAnalysis}
library(dplyr)

stats1 <- sea.deep %>% #Detailed statistical summary by depth and year
  group_by(fondària, any) %>%
  summarise(
    Mitjana = mean(temperatura),
    Mediana = median(temperatura),
    SD = sd(temperatura),
    IQR = IQR(temperatura),
    Min = min(temperatura), #Other statistics of interest
    Max = max(temperatura),
    Range = Max - Min, #Difference between max and min values
    CV = SD / Mitjana, #Coefficient of Variation (CV)
    .groups = 'drop'
   ) 

print(stats1) 
View(stats1) #Average temperature per depth per year

temp_dy <- sea.deep %>% #Isolating the average temperature per depth and year
  group_by(fondària, any) %>% #Variables of interest
  summarise(
    temp_mitja = mean(temperatura),
    .groups = 'drop'
  ) #New variable average temperature per depth per year
print(temp_dy)

stats2 <- temp_dy %>% #Aggregate statistics by depth 
  group_by(fondària) %>%
  summarise(
    Mitjana = mean(temp_mitja),
    Mediana = median(temp_mitja),
    SD = sd(temp_mitja),
    IQR = IQR(temp_mitja),
    Min = min(temp_mitja), #Other statistics of interest
    Max = max(temp_mitja),
    Range = Max - Min, #Difference between max and min values
    CV = SD / Mitjana, #Coefficient of Variation (CV)
    .groups = 'drop'
  )

print(stats2) 
View(stats2) #Average temperature by depth across 2000-2017   

```

### 1.f) Trend analysis - Annual variations

```{r AnnnualVariations, echo=FALSE}
stats1 <- stats1 %>%
  mutate(fondària = factor(fondària, levels = c(0, -20, -50, -80))) #Ensure depth levels are trated as categorical factors

ggplot(stats1, aes( #Create the time-series plot
  x = any, 
  y = Mitjana, 
  color = fondària)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Variació anual de la temperatura mitjana per fondària",
    subtitle = " (2000-2017) Mar Mediterrani, punt d'observació: 42º 03' N, 3º 15' E", #####Acabar de decidir títols i subtítols
    x = "Any",
    y = "Temperatura mitjana (°C)",
    color = "Fondària (m)"
  ) +
  theme_minimal()
  theme(legend.position = "bottom") # Optional: Move legend to bottom for better horizontal space

```

### 1.g) Data export to Excel

The information that has been processed, which includes yearly statistics and long-term totals, is sent to an outside .xlsx file using the [openxlsx]{.smallcaps} package. This process makes sure that the data is stored and can be used for external reporting or further analysis. The workbook has two sheets, including *"Stats_per_any"* and *"Stats_globals"*.

```{r, Excel}
library(openxlsx)

new_var <- createWorkbook()
#Average temperature per depth per year
addWorksheet(new_var, "Stats_per_any")
writeData(new_var, "Stats_per_any", stats1)
#Average temperature per depth across 2000-2017   
addWorksheet(new_var, "Stats_globals")
writeData(new_var, "Stats_globals", stats2)
#Save on a new excel file
saveWorkbook(new_var, "NUEVO.xlsx", overwrite = TRUE)
```

## Exercise 2

### 2.a) [gplots]{.smallcaps} - Heatmap

```{r Heatmap, echo=FALSE}
#Run libraries 
library(tidyr)
library(gplots)
library(RColorBrewer)

#Remove annual average temperature observations, keep only the months from January to December
if ("mes" %in% names(sea.deep)) {
  obs <- sea.deep[sea.deep$mes != "Mitjana anual", ]
} else {
  obs <- sea.deep
}

temp_dy <- obs %>% #Calculate the average temperature per year by depth
  group_by(any, fondària) %>%
  summarise(
    mean = mean(temperatura),
    sd   = sd(temperatura),
    n    = n()
  ) %>%
  ungroup() %>%
  arrange(any, fondària)

#Prepare the data for heatmap.2 representation by creating two matrices 
fondària <- c(-80, -50, -20, 0)

matriu_1 <- temp_dy %>%
  select(any, fondària, mean) %>%
  pivot_wider(names_from = fondària, values_from = mean) %>%
  arrange(any)
anys <- matriu_1$any
columnes <- intersect(as.character(fondària), colnames(matriu_1))
rownames(matriu_1) <- anys
mitjana_temp_mat <- as.matrix(matriu_1[, columnes])

matriu_2 <- temp_dy %>%
  select(any, fondària, sd) %>%
  pivot_wider(names_from = fondària, values_from = sd) %>%
  arrange(any)
rownames(matriu_2) <- matriu_2$any
sd_temp_mat <- as.matrix(matriu_2[, columnes])

tons_heatmap <- colorRampPalette(brewer.pal(9, "YlOrRd"))(100) #Select map color palette

heatmap.2( #Map design and specifications
  mitjana_temp_mat,
  Rowv = FALSE, Colv = FALSE, dendrogram = "none",
  trace = "none", key = TRUE, density.info = "none",
  col = tons_heatmap, na.color = "grey90",
  margins = c(7, 9),
  main = "",
  xlab = "Fondària (m)", ylab = "Any",
  labCol = columnes,
  labRow = as.character(anys),
  cexRow = 0.9, cexCol = 1.0,
  add.expr = {
    nr <- nrow(sd_temp_mat); nc <- ncol(sd_temp_mat)
    for (j in seq_len(nc)) {
      s <- sd_temp_mat[, j]
      if (all(is.na(s))) next
      rng <- range(s)
      y <- sapply(seq_len(nr), function(i) nr - i + 1)
      if (!is.finite(diff(rng)) || diff(rng) == 0) {
        x <- rep(j, nr)
      } else {
        x_scaled <- (s - rng[1]) / diff(rng)
        x <- (j - 0.5) + x_scaled
      }
      lines(x, y, col = "cyan3", lwd = 2)
      points(x, y, col = "cyan3", pch = 20, cex = 0.75)
    }
  }
)
#Late addition of the title and adjustments to avoid overlap
title("Temperatura mitjana per any i fondària",
      adj = 1,           
      line = 1.2,        
      cex.main = 1.1)   
```

The heatmap shows how the annual mean water temperature changes at different depths (-80, -50, -20 and 0 meters) between 2000 and 2017. The colour distribution shows that surface waters (0 and -20 meters) are consistently the warmest and exhibit the greatest interannual variability. This variability is evident in the blue lines representing the standard deviation (SD), which are imposed on the heatmap. The deeper layers (-50 and -80 meters) display a colder and more stable thermal profile, with significantly reduced standard deviation, indicating lower influence from seasonal cycles. The period between 2014 and 2016 stands out as particularly intense warming conditions are observed at the surface, potentially driven by large-scale oceanographic or climatic dynamics.

### 2.b) [plotrix]{.smallcaps} - Radial plot

```{r Radial, warning=FALSE}
#Run library 
library(plotrix) 

mes_l <- c("Gener", "Febrer", "Març", "Abril", "Maig", "Juny", 
           "Juliol", "Agost", "Setembre", "Octubre", "Novembre", "Desembre")

radial_data <- sea.deep %>% #Filter out annual averages and calculate mean temperature per month and depth
  filter(mes != 'Mitjana anual') %>%
  mutate(mes = factor(mes, levels = mes_l)) %>%
  group_by(mes, fondària) %>%
  summarise(avg_temp = mean(temperatura, na.rm = TRUE), .groups = 'drop')

plot_matrix <- radial_data %>% #Data as matrix for the radial plot
  pivot_wider(names_from = fondària, values_from = avg_temp) %>%
  arrange(mes) %>%
  select(-mes) %>%
  as.matrix()

plot_matrix = rbind(plot_matrix, plot_matrix[1, 1:4]) #Append the first row to the end so the lines connect back to January

depth_levels <- colnames(plot_matrix) #Setup parameters
num_depths <- length(depth_levels)

col_set = c("#F8766D","#7CAE00", "#00BFC4", "#C77CFF")

angles <- c((0:(length(mes_l) - 1)) * (2 * pi / length(mes_l)),0) #Calculate angles in radians for each month

radial.plot( #Plot design and specifications
  t(plot_matrix), radial.pos = t(replicate(4, angles)), rp.type = "l",
  lty = 4, lwd = 2,
  labels = mes_l, label.pos = angles, line.col = col_set,
  radial.lim = c(0, 30),
  main = "Average Monthly Temperature by Depth (All Years)",
  clockwise = TRUE, start = pi/2
)


legend(
  "bottomright", legend = paste(depth_levels, "m"),
   col=col_set, lty = 4, lwd = 2, bty = "n"
)
```

The radial plot shows how average temperatures recorded at different depths (-80, -50, -20 and 0 metres) changed across each month of the year from 2000 to 2017. The near-perfect overlap of the lines between December and March stands out, showing that temperature values remain almost identical regardless of depth. In contrast, a shift begins in April, becoming most pronounced during the summer months. While surface temperatures at 0 m and -20 m show a sharp expansion towards higher values, deeper measurements at -50 m and -80 m remain closer to the center of the plot. As the year progresses into November and December, these temperature values contract and converge again. Furthermore, the plot shows that the surface is subject to significant monthly temperature fluctuations, whereas the deeper layers have a much more consistent and narrow temperature range throughout the year.

## Exercise 3

A function is scheduled to do the following: 
\* a) Calculates the temperature difference between one month and the following month for each year and depth, offering a graph for each specified year and the average of all years studied. 
\* b) Calculates the difference in temperature between each month and the same month of the previous 30 years, offering a graph for each year and the average for all years studied.

### 3.a) Temperature differences between months

```{r MontlyChange}
library(stringr )
source('Ex3.R')
plots = ex3(sea.deep, sea.pred)
print(plots$a)

```

### 3.b) Temperature differences between years

```{r Historical}
print(plots$b1)
```

```{r YearlyHistorical}
print(plots$b2)
```

### 3.c) Simulated dataframe

To make sure the function works properly and everything runs smoothly, we generate some simulated temperatures. For this, we use a noisy sine function with a period of 12 months.

```{r}
#Define simulation parameters
anys = 18 
min_sim = 13
ampl_sim = c(1,2,3,4)
#Structure of simulated df 
sim.deep = data.frame(
  mes = rep(mes_l, anys, each=4),
  fondària = rep(fondària, anys*12),
  any = rep(seq(2000, 2000+anys-1), each=4*12),
  temperatura = rep(0, 4*12*anys)
)
for (i in 1:4){ #Loop
  sim_t = sin(2*pi*seq(0, anys, 1/12))*ampl_sim[i]
  sim_t = sim_t + rnorm(length(sim_t), min_sim+ampl_sim[i], 1)
  sim.deep$temperatura[sim.deep$fondària==fondària[i]] = sim_t[1:length(sim_t)-1]
}
#Process the data to create long-term trends
sim.pred <- sim.deep %>%
  group_by(mes, fondària) %>%
  arrange(any, .by_group = TRUE) %>%
  mutate(temperatura_accum = cummean(temperatura)) %>% #To smooth out year-to-year noise
  ungroup()
```

```{r}
plots = ex3(sim.deep, sim.pred)
print(plots$b2)
```

### 3.d) Comment on the results found

When we look at how temperatures change from month to month, we can see a clear difference between the surface and the deeper water during summer periods. For instance in August, the surface is about 23°C, but the water at 80 meters is much cooler and more stable. This means there is a risk of different layers of water getting too hot or too cold. This happens because warm water is lighter than cold water creating a "cap" on the surface that acts like a barrier that stops oxygen from moving down and nutrients from moving up. This can eventually lead to a "bottom-up" collapse of the food chain and create "dead zones" where there is too little oxygen for animals and plants to survive. What's more, if we compare the temperatures of the last few years to the average temperature between 1974 and 1999, we can see that the temperature has been getting steadily higher. The water was much warmer than usual in 2003, 2011, and 2017. 

We used pretend data to show that our function and our calculations are correct. We created a mathematical "sine wave" to copy the natural 12-month cycle of the seasons. This showed that we can spot regular patterns even when there is random "noise" in the data. If we calculate the average of the total, we can make the results more stable and reliable. This helps us to see the bigger picture without getting distracted by small changes that happen every year.

In summary, the results show that the sea is getting warmer, which is a big threat to marine biodiversity. The difference between the temperatures at the surface of the ocean and at depth is getting bigger, and we are seeing more "heat spikes" than before. These changes are not just part of a natural cycle but they are clear signs of climate change.


### 3.e) Additional data (salinity) crossing

We look for other data to better explain the climate change that is taking place. To be more specific, we are looking for information about the salt content of the water at a close location and at different depths (0, 20, 50 and 80 metres). We get our information from  <https://data.marine.copernicus.eu/product/MEDSEA_ANALYSISFORECAST_BGC_006_014/description>. 

The saltiness of water is as important as temperature when diagnosing climate change, but it tells us different things than temperature alone. Salinity is a way to measure climate change. It shows how the water cycle is changing. When it gets warmer, more water evaporates and the water becomes saltier.  So, if the salt levels in the ocean suddenly drop a lot, it could be a sign of extreme weather or melting ice on other parts of the planet. Changes in the amount of salt in the water change how thick or thin the water is, and can make the layers of the water more stable. Salinity drives the global "conveyor belt" of ocean currents, so changes to it could disrupt how heat is distributed around the planet and put ecosystems under more stress.

```{r}
library(ncdf4)

# Loading the file
nc_file = nc_open("cmems_mod_med_phy-sal_my_4.2km_P1M-m_1766852522604.nc")

# Extracting the data and transforming to a dataframe
salinity_mat = ncvar_get(nc_file, nc_file$var[[1]])
salinity = data.frame(
  Time = rep(nc_file$dim$time$vals, times = nrow(salinity_mat)),
  fondària = rep(round(nc_file$dim$depth$vals), times = ncol(salinity_mat)),
  salinitat = as.vector(salinity_mat)
)

# Changing dates to year/month
date_objs = as.POSIXct(salinity$Time, origin = "1970-01-01", tz = "UTC")
salinity$any = as.numeric(format(date_objs, "%Y"))
month_index = as.numeric(format(date_objs, "%m"))
salinity$mes = mes_l[month_index]
salinity$Time = NULL

# Adjusting depths to fit existing data
salinity <- salinity[salinity$fondària %in% c(1, 19, 51, 79), ]
salinity$fondària[salinity$fondària == 1] = 0
salinity$fondària[salinity$fondària == 19] = -20
salinity$fondària[salinity$fondària == 51] = -50
salinity$fondària[salinity$fondària == 79] = -80

# Creating combined dataframe to estimate linear relation
df_combined <- sea.deep %>%
  inner_join(salinity, by = c("any", "mes", "fondària"), suffix = c("_df1", "_df2"))

correlation_value <- cor(df_combined$temperatura, 
                         df_combined$salinitat, 
                         use = "complete.obs")

print(correlation_value)

aa = lm(temperatura ~ salinitat, df_combined)
summary(aa)
```

By combining these sets of data, we can better tell the difference between the usual seasonal changes and long-term shifts caused by climate change, which changes how water moves through the environment. The data shows that temperature and salinity usually go in opposite directions. Although the connection is only weak (correlation -0.12), the very low p-value of 0.00032 shows that this link is real and not just a coincidence.

The Multiple R-squared of 0.0149 shows that salinity explains only about 1.5% of the variation in temperature. This result is expected in the study of the sea, as the temperature of seawater is primarily driven by the sun and changes with the seasons, rather than the salt content alone. But the data also show that when the sea is very salty, it is often very hot. These changes can be too much for marine life, which can't handle the heat and the changes to the water.

In conclusion, while salinity is not the main cause of temperature changes, it is an important tool for understanding the biochemical changes triggered by global warming. Our model clearly shows a connection between these two variables. When we look at how climate change is affecting the sea, measuring salt levels and temperature helps us to see how the layers of the sea are becoming more separated. This tells us about dead zones, which are areas of the sea where there are no fish because the water is too polluted. This also gives us a better idea of all the problems that fish and other sea life are facing.


### 3.f) R library and Github

To make sure the analysis is transparent and can be recreated by anyone, a public repository named "SeaTemperature" has been set up on GitHub <https://github.com/eaTaki/SeaTemperature>. This repository is a central open-source storage space for the following components:
\* Assignment instructions 
\* R library that stores the functions used for the completion of this project, thus being: CreateDF and Ex3.
\* Salinity data used to complete exercise 3.e.  
\* Etc especificar según contenidos finales
